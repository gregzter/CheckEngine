#!/usr/bin/env php
<?php

/**
 * Script de dÃ©monstration du OBD2ColumnMapper (Version 2.0 - BDD)
 *
 * Analyse le fichier CSV rÃ©el et affiche le mapping des colonnes
 * Utilise maintenant le mapping depuis la base de donnÃ©es
 */

require __DIR__ . '/../vendor/autoload.php';

use App\Kernel;
use Symfony\Component\Dotenv\Dotenv;

// Charger les variables d'environnement
(new Dotenv())->bootEnv(__DIR__ . '/../.env');

// DÃ©marrer le kernel Symfony
$kernel = new Kernel($_ENV['APP_ENV'] ?? 'dev', (bool) ($_ENV['APP_DEBUG'] ?? true));
$kernel->boot();
$container = $kernel->getContainer();

// RÃ©cupÃ©rer le service OBD2ColumnMapper depuis le container
$mapper = $container->get('App\Service\OBD2ColumnMapper');

// Chemin du fichier CSV d'exemple (peut Ãªtre passÃ© en argument)
$csvPath = $argv[1] ?? __DIR__ . '/../var/tmp/data/trackLog-2025-oct.-23_12-00-00.csv';

if (!file_exists($csvPath)) {
    echo "âŒ Fichier CSV non trouvÃ©: $csvPath\n";
    echo "   Extrayez d'abord le fichier ZIP d'exemple.\n";
    exit(1);
}

// Lecture du header CSV
$handle = fopen($csvPath, 'r');
$csvHeaders = fgetcsv($handle);
fclose($handle);

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n";
echo "â•‘  OBD2 COLUMN MAPPER - Analyse du fichier Torque Pro         â•‘\n";
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

// Statistiques gÃ©nÃ©rales
$stats = $mapper->getMappingStats($csvHeaders);
echo "ğŸ“Š STATISTIQUES GÃ‰NÃ‰RALES\n";
echo "   Total colonnes CSV:        {$stats['total_columns']}\n";
echo "   Colonnes reconnues:        {$stats['mapped_columns']}\n";
echo "   Colonnes non reconnues:    {$stats['unmapped_columns']}\n";
echo "   Sources multiples:         {$stats['duplicate_sources']}\n";
echo "   Taux de reconnaissance:    {$stats['mapping_rate']}%\n";
echo "\n";

// Mapping dÃ©taillÃ©
$result = $mapper->mapCsvHeaders($csvHeaders);

if (!empty($result['unmapped'])) {
    echo "âš ï¸  COLONNES NON RECONNUES\n";
    foreach ($result['unmapped'] as $col) {
        echo "   âŒ $col\n";
    }
    echo "\n";
}

if (!empty($result['duplicates'])) {
    echo "ğŸ”„ DOUBLONS DÃ‰TECTÃ‰S (plusieurs sources pour la mÃªme donnÃ©e)\n";
    foreach ($result['duplicates'] as $dbName => $sources) {
        echo "   ğŸ“Œ $dbName:\n";
        foreach ($sources as $source) {
            $marker = ($source === $result['mapped'][$dbName]) ? 'âœ“' : 'â—‹';
            echo "      $marker [{$source['priority']}] {$source['csv_column']} (index {$source['index']})\n";
        }
        echo "\n";
    }
}

// Colonnes mappÃ©es par catÃ©gorie
echo "âœ… COLONNES MAPPÃ‰ES PAR CATÃ‰GORIE\n\n";

$categories = [
    'Temporel/GPS' => ['timestamp_gps', 'timestamp_device', 'longitude', 'latitude', 'gps_speed_ms', 'gps_altitude', 'gps_bearing', 'gps_accuracy', 'gps_hdop', 'gps_satellites'],
    'AccÃ©lÃ©romÃ¨tre' => ['accel_x', 'accel_y', 'accel_z', 'accel_total'],
    'Sondes Lambda/O2' => ['o2_b1s1_voltage', 'o2_b1s1_voltage_wide', 'o2_b1s1_lambda', 'o2_b1s1_current', 'o2_b1s2_voltage', 'prius_af_lambda', 'prius_afs_voltage'],
    'Air/Fuel Ratio' => ['afr_measured', 'afr_commanded', 'lambda_commanded', 'stft_b1', 'ltft_b1'],
    'TempÃ©ratures' => ['coolant_temp', 'prius_coolant_7c0', 'prius_coolant_7e0', 'prius_coolant_7c4', 'prius_coolant_7e2', 'intake_air_temp', 'prius_iat_7e0', 'prius_iat_7e2', 'ambient_temp', 'catalyst_temp_b1s1', 'catalyst_temp_b1s2'],
    'RÃ©gime moteur' => ['engine_rpm', 'prius_rpm_7e0', 'prius_rpm_7e2', 'prius_rpm_cyl1', 'prius_rpm_cyl2', 'prius_rpm_cyl3', 'prius_rpm_cyl4'],
    'Vitesse vÃ©hicule' => ['vehicle_speed', 'prius_speed_7b0', 'prius_speed_7e0', 'prius_speed_7e2', 'prius_wheel_speed_fr', 'speed_difference'],
    'Charge/Air' => ['engine_load', 'engine_load_absolute', 'throttle_position', 'maf_rate', 'prius_maf', 'barometric_pressure'],
    'Diagnostics' => ['prius_misfire_count']
];

foreach ($categories as $catName => $columns) {
    $found = [];
    foreach ($columns as $col) {
        if (isset($result['mapped'][$col])) {
            $found[] = $col;
        }
    }

    if (!empty($found)) {
        echo "   ğŸ“ $catName (" . count($found) . ")\n";
        foreach ($found as $col) {
            $csvCol = $result['mapped'][$col]['csv_column'];
            echo "      â€¢ $col â† \"$csvCol\"\n";
        }
        echo "\n";
    }
}

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
echo "âœ“ Analyse terminÃ©e avec succÃ¨s\n";
