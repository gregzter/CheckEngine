#!/usr/bin/env php
<?php

/**
 * DÃ©monstration complÃ¨te de l'analyse de colonnes OBD2 (Version 2.0 - BDD)
 * - Mapping des colonnes (depuis base de donnÃ©es)
 * - Validation des donnÃ©es
 * - DÃ©tection de doublons
 * - VÃ©rification de corrÃ©lation
 * - SÃ©lection de la meilleure source
 */

require __DIR__ . '/../vendor/autoload.php';

use App\Kernel;
use Symfony\Component\Dotenv\Dotenv;

// Charger les variables d'environnement
(new Dotenv())->bootEnv(__DIR__ . '/../.env');

// DÃ©marrer le kernel Symfony
$kernel = new Kernel($_ENV['APP_ENV'] ?? 'dev', (bool) ($_ENV['APP_DEBUG'] ?? true));
$kernel->boot();
$container = $kernel->getContainer();

// RÃ©cupÃ©rer les services depuis le container
$mapper = $container->get('App\Service\OBD2ColumnMapper');
$detector = $container->get('App\Service\DiagnosticDetector');

// Chemin du fichier CSV d'exemple (peut Ãªtre passÃ© en argument)
$csvPath = $argv[1] ?? __DIR__ . '/../var/tmp/data/trackLog-2025-oct.-23_12-00-00.csv';

if (!file_exists($csvPath)) {
    echo "âŒ Fichier CSV non trouvÃ©: $csvPath\n";
    exit(1);
}

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n";
echo "â•‘   ANALYSE COMPLÃˆTE DES DONNÃ‰ES OBD2 - Torque Pro            â•‘\n";
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

// Lecture du CSV complet
$handle = fopen($csvPath, 'r');
$csvHeaders = fgetcsv($handle);

// Charger toutes les donnÃ©es en mÃ©moire pour validation
$columnsData = array_fill(0, count($csvHeaders), []);
while (($row = fgetcsv($handle)) !== false) {
    foreach ($row as $idx => $value) {
        $columnsData[$idx][] = $value;
    }
}
fclose($handle);

echo "ğŸ“Š Ã‰TAPE 1: MAPPING DES COLONNES\n";
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

$mapping = $mapper->mapCsvHeaders($csvHeaders);
$stats = $mapper->getMappingStats($csvHeaders);

echo "Total colonnes CSV: {$stats['total_columns']}\n";
echo "Colonnes reconnues: {$stats['mapped_columns']}\n";
echo "Taux reconnaissance: {$stats['mapping_rate']}%\n";
echo "Sources multiples: {$stats['duplicate_sources']}\n\n";

// Afficher les doublons dÃ©tectÃ©s
if (!empty($mapping['duplicates'])) {
    echo "ğŸ”„ DOUBLONS DÃ‰TECTÃ‰S\n";
    foreach ($mapping['duplicates'] as $dbName => $sources) {
        echo "\nğŸ“Œ $dbName (" . count($sources) . " sources):\n";
        foreach ($sources as $source) {
            $csvCol = $source['csv_column'];
            $priority = $source['priority'];
            $index = $source['index'];
            echo "   â€¢ [$priority] $csvCol (col $index)\n";
        }
    }
    echo "\n";
}

echo "\nğŸ“Š Ã‰TAPE 2: VALIDATION DES DONNÃ‰ES\n";
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

// Valider chaque colonne mappÃ©e
$validatedColumns = [];
foreach ($mapping['mapped'] as $dbName => $columnInfo) {
    $index = $columnInfo['index'];
    $data = $columnsData[$index];

    $validation = $detector->validateColumnData($data, $dbName);

    $validatedColumns[$dbName] = [
        'csv_column' => $columnInfo['csv_column'],
        'index' => $index,
        'validation' => $validation,
        'data' => $data
    ];
}

// Afficher statistiques de validation
$validColumns = array_filter($validatedColumns, fn($col) => $col['validation']['valid']);
$invalidColumns = array_filter($validatedColumns, fn($col) => !$col['validation']['valid']);

echo "âœ… Colonnes VALIDES: " . count($validColumns) . "\n";
echo "âŒ Colonnes INVALIDES: " . count($invalidColumns) . "\n\n";

if (!empty($invalidColumns)) {
    echo "âš ï¸  COLONNES INVALIDES (donnÃ©es inutilisables):\n\n";
    foreach ($invalidColumns as $dbName => $col) {
        $stats = $col['validation']['stats'];
        $reason = $col['validation']['reason'];
        echo "   âŒ $dbName\n";
        echo "      Colonne CSV: {$col['csv_column']}\n";
        echo "      Raison: $reason\n";
        echo "      DonnÃ©es valides: {$stats['valid_rate']}%\n";
        echo "      Valeurs d'erreur: {$stats['error_value_count']}\n";
        echo "      Valeurs nulles: {$stats['null_count']}\n\n";
    }
}

echo "\nğŸ“Š Ã‰TAPE 3: GESTION DES DOUBLONS\n";
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

if (!empty($mapping['duplicates'])) {
    foreach ($mapping['duplicates'] as $dbName => $sources) {
        echo "ğŸ” Analyse de '$dbName':\n\n";

        // PrÃ©parer les donnÃ©es pour selectBestColumn
        $duplicatesData = [];
        foreach ($sources as $source) {
            $index = $source['index'];
            $duplicatesData[] = [
                'db_name' => $dbName,
                'csv_column' => $source['csv_column'],
                'priority' => $source['priority'],
                'index' => $index,
                'data' => $columnsData[$index]
            ];
        }

        // Calculer les corrÃ©lations entre sources
        if (count($duplicatesData) > 1) {
            echo "   ğŸ“ˆ CorrÃ©lations entre sources:\n";
            for ($i = 0; $i < count($duplicatesData) - 1; $i++) {
                for ($j = $i + 1; $j < count($duplicatesData); $j++) {
                    $corr = $detector->calculateColumnCorrelation(
                        $duplicatesData[$i]['data'],
                        $duplicatesData[$j]['data']
                    );

                    $src1 = $duplicatesData[$i]['csv_column'];
                    $src2 = $duplicatesData[$j]['csv_column'];

                    $corrIcon = $corr >= 80 ? 'âœ…' : ($corr >= 50 ? 'âš ï¸' : 'âŒ');
                    echo "      $corrIcon $src1 <-> $src2: {$corr}%\n";
                }
            }
            echo "\n";
        }

        // SÃ©lectionner la meilleure source
        $best = $detector->selectBestColumn($duplicatesData, true);

        if ($best) {
            $validation = $detector->validateColumnData($best['data'], $dbName);
            echo "   âœ… SOURCE SÃ‰LECTIONNÃ‰E: {$best['csv_column']}\n";
            echo "      PrioritÃ©: {$best['priority']}\n";
            echo "      DonnÃ©es valides: {$validation['stats']['valid_rate']}%\n";
            echo "      Min: {$validation['stats']['min']}, Max: {$validation['stats']['max']}\n";
            echo "      Moyenne: {$validation['stats']['avg']}\n\n";
        } else {
            echo "   âŒ AUCUNE SOURCE VALIDE\n\n";
        }
    }
}

echo "\nğŸ“Š Ã‰TAPE 4: DÃ‰TECTION DES DIAGNOSTICS POSSIBLES\n";
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";

$diagnostics = $detector->detectAvailableDiagnostics($validatedColumns);

foreach ($diagnostics as $diagType => $result) {
    $icon = $result['available'] ? 'âœ…' : 'âŒ';
    $confidence = $result['confidence'];
    $completeness = $result['completeness'];

    echo "$icon " . strtoupper($diagType) . "\n";
    echo "   Disponible: " . ($result['available'] ? 'OUI' : 'NON') . "\n";
    echo "   ComplÃ©tude: {$completeness}%\n";
    echo "   Confiance: $confidence\n";
    echo "   Score obligatoires: {$result['mandatory_score']}%\n";
    echo "   Score recommandÃ©es: {$result['recommended_score']}%\n";

    if (!empty($result['missing_mandatory'])) {
        echo "   âš ï¸  Manque (obligatoires): " . implode(', ', $result['missing_mandatory']) . "\n";
    }

    echo "\n";
}

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
echo "âœ“ Analyse complÃ¨te terminÃ©e\n";
