#!/bin/bash
# Script de vÃ©rification et migration TimescaleDB
# Ã€ exÃ©cuter aprÃ¨s redÃ©marrage des containers

set -e

echo "ğŸ” Ã‰TAPE 1: VÃ©rification TimescaleDB"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

cd /workspace/backend-symfony

echo "1ï¸âƒ£ VÃ©rification shared_preload_libraries..."
php bin/console dbal:run-sql "SHOW shared_preload_libraries;" || {
    echo "âŒ Erreur: PostgreSQL non accessible"
    exit 1
}

echo ""
echo "2ï¸âƒ£ CrÃ©ation extension TimescaleDB..."
php bin/console dbal:run-sql "CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE;" || {
    echo "âŒ Erreur: TimescaleDB ne peut pas Ãªtre chargÃ©"
    echo "ğŸ’¡ Avez-vous bien redÃ©marrÃ© les containers ?"
    exit 1
}

echo ""
echo "3ï¸âƒ£ VÃ©rification version TimescaleDB..."
php bin/console dbal:run-sql "SELECT extname, extversion FROM pg_extension WHERE extname = 'timescaledb';"

echo ""
echo "âœ… TimescaleDB configurÃ© avec succÃ¨s!"
echo ""
echo "ğŸ”„ Ã‰TAPE 2: ExÃ©cution des migrations"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

php bin/console doctrine:migrations:migrate --no-interaction

echo ""
echo "ğŸ“Š Ã‰TAPE 3: VÃ©rification hypertable"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

php bin/console dbal:run-sql "
SELECT
    hypertable_name,
    num_chunks,
    compression_enabled
FROM timescaledb_information.hypertables
WHERE hypertable_name = 'trip_data';
" || echo "âš ï¸  Hypertable pas encore crÃ©Ã©e (normal si premiÃ¨re migration)"

echo ""
echo "ğŸ“¦ Ã‰TAPE 4: Chargement fixtures OBD2"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

php bin/console doctrine:fixtures:load --no-interaction

echo ""
echo "ğŸ‰ CONFIGURATION TERMINÃ‰E !"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ“ Prochaines Ã©tapes :"
echo "  1. Tester le parser CSV :"
echo "     php bin/demo-parse-csv var/tmp/data/trackLog-2025-oct.-23_12-00-00.csv"
echo ""
echo "  2. Tester le mapping colonnes :"
echo "     php bin/demo-column-mapper"
echo ""
echo "  3. Voir les statistiques BDD :"
echo "     php bin/console dbal:run-sql \"SELECT COUNT(*) FROM obd2_column_variant;\""
