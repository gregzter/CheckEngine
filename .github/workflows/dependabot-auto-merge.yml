name: Auto-merge Dependabot PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¤– Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: âœ… Auto-approve PR
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr review --approve "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”„ Enable auto-merge (wait for CI)
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“Š Comment on PR
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr comment "$PR_URL" --body "ðŸ¤– Auto-merge activÃ© ! Cette PR sera mergÃ©e automatiquement une fois les checks CI passÃ©s. âœ…"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: âš ï¸ Comment for major updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr comment "$PR_URL" --body "âš ï¸ **Mise Ã  jour majeure dÃ©tectÃ©e !**
          
          Cette PR contient une mise Ã  jour majeure qui peut inclure des breaking changes.
          Veuillez la reviewer manuellement avant de merger.
          
          Package: \`${{ steps.metadata.outputs.dependency-names }}\`
          Version: \`${{ steps.metadata.outputs.previous-version }}\` â†’ \`${{ steps.metadata.outputs.new-version }}\`"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  dependabot-summary:
    name: Dependabot Summary
    runs-on: ubuntu-latest
    needs: auto-merge
    if: always() && github.actor == 'dependabot[bot]'
    
    steps:
      - name: ðŸ“Š Update Summary
        run: |
          echo "## ðŸ¤– Dependabot Auto-merge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Auto-merge result: ${{ needs.auto-merge.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Patch updates**: Auto-merge enabled" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… **Minor updates**: Auto-merge enabled" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸ **Major updates**: Manual review required" >> $GITHUB_STEP_SUMMARY
